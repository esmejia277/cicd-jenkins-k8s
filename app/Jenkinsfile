pipeline {
    agent any

    triggers {
        githubPush()
    }

    environment {
        REGISTRY = "esmejia277"
        IMAGE = "simple-app"
    }

    stages {
        stage('Build & Push Docker image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'Dockerhub',
                                                  usernameVariable: 'DOCKER_USER',
                                                  passwordVariable: 'DOCKER_PASS')]) {
                    script {
                        // Normaliza la rama y genera release name único
                        def branch = env.GIT_BRANCH.replaceAll('/', '-')
                        def shortBranch = branch.take(30) // evita nombres larguísimos
                        def shortSha = env.GIT_COMMIT.take(8)
                        env.RELEASE_NAME = "${IMAGE}-${shortBranch}-${shortSha}"
                        env.IMAGE_TAG = "${shortSha}"

                        // Build y push
                        sh """
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker build -t ${REGISTRY}/${IMAGE}:${IMAGE_TAG} app
                        docker push ${REGISTRY}/${IMAGE}:${IMAGE_TAG}
                        """
                    }
                }
            }
        }

        stage('Deploy with Helm') {
            steps {
                script {
                    def branch = env.GIT_BRANCH.replaceAll('/', '-')
                    
                    if (branch.startsWith("feature-")) {
                        echo "Deploying feature branch: ${branch}"
                        sh """
                        helm upgrade --install ${RELEASE_NAME} app/k8s/helm/simple-api \
                            -f app/k8s/helm/simple-api/values-feature.yaml \
                            --set image.repository=${REGISTRY}/${IMAGE} \
                            --set image.tag=${IMAGE_TAG} \
                            --set commitSha=${IMAGE_TAG} \
                            -n feature
                        """
                    } else if (branch == "main") {
                        echo "Deploying to PROD"
                        sh """
                        helm upgrade --install ${RELEASE_NAME} app/k8s/helm/simple-api \
                            -f app/k8s/helm/simple-api/values-prod.yaml \
                            --set image.repository=${REGISTRY}/${IMAGE} \
                            --set image.tag=${IMAGE_TAG} \
                            --set commitSha=${IMAGE_TAG} \
                            -n prod
                        """
                    } else {
                        echo "Branch ${branch} not configured for deployment"
                    }
                }
            }
        }
    }
}
